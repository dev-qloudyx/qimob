{% extends base_template %}
{% load i18n %}
{% block content %}


<span id="notification"></span>
<h2 class="listtitle">{{ object.short_name}}</h2>
<span style="display: flex; margin-right: 20px;">
  
  <form method="post" style='padding:0px'>
    {% csrf_token %}
    <a href="{% url 'crm:lead_update_view' lead.id %}" class="btn btn-primary mb-3">Update</a>
    <a href="#" class="btn btn-primary mb-3">{% trans "Logs" %}</a>
    <button class="btn btn-primary mb-3">Checklist</button> 
    {% if buttontext %}
    <button type="submit" class="btn btn-primary mb-3" name="cancel">{{ buttontext }}</button> 
    {% endif %}
 
  </form>
</span>

<div class="detailsview">
    
    
    <button class="collapsible"><h3>{% trans "Lead Data" %}</h3></button>
    <div class="content">
      <p><b class="title">License:</b> {{ object.license.name}}</p>
      <p><b class="title">Owner:</b> {{ object.owner.username}}</p>
      <p><b class="title">Type:</b> {{ object.leadtype }}</p>
      <p><b class="title">Short description:</b> {{ object.short_desc }}</p>
      <p><b class="title">Description:</b> {{ object.desc }}</p>
      <p><b class="title">Created at:</b> {{ object.created_at }}</p>
    </div>


    <button class="collapsible"><h3>{% trans "Client Data" %}</h3></button>
    <div class="content">
      <p><b class="title">Name:</b> {{ clientdata.name }}</p>
      <p><b class="title">Phone Number:</b> {{ clientdata.phone_number }}</p>
      <p><b class="title">Email:</b> {{ clientdata.email_address }}</p>
      <p><b class="title">NIF:</b> {{ clientdata.nif }}</p>
      <p><b class="title">Identity Document:</b> {{ clientdata.ident_doc }}</p>
      <p><b class="title">Link:</b> {{ clientdata.url}}</p>
    </div>

    <button class="collapsible"><h3>{% trans "House Data" %}</h3></button>
    <div class="content">
      <p><b class="title">{% trans "Name" %}:</b> {{ imoveldata.name }}</p>
      <p><b class="title">{% trans "House Type" %}:</b> {{ imoveldata.imovel_type }}</p>
      <p><b class="title">{% trans "Address" %}:</b> {{ imoveldata.address }}</p>
      <p><b class="title">{% trans "Price" %}:</b> {{ imoveldata.price }} â‚¬</p>
      <p><b class="title">{% trans "Square Footage" %}:</b> {{ imoveldata.square_footage }} M<sup>2</sup></p>
      <p><b class="title">{% trans "Number of Bedrooms" %}:</b> {{ imoveldata.bedrooms }}</p>
      <p><b class="title">{% trans "Number of Bathrooms" %}:</b> {{ imoveldata.bathrooms }}</p>
      <p><b class="title">{% trans "Description" %}:</b> {{ imoveldata.description}}</p>
    </div>


    <button class="collapsible"><h3>Documents</h3> </button>
    <div class="content">
      <a href="{% url 'crm:lead_docs_upload_view' lead.pk %}" class="btn btn-primary mb-3">Add Document</a>
    
      {% if doc_files %}
        {% for doc in doc_files %}
        <p>Download File: <a href="{{ MEDIA_URL }}{{ doc.upload }}" target="_blank">{{ MEDIA_URL }}{{ doc.upload }}</a></p>
        {% endfor %}
      {% else %}
        <p>No document found</p>
      {% endif %}
    </div>

    <button class="collapsible"><h3>Prospects</h3> </button>
    <div class="content">
      <a href="#" class="btn btn-primary mb-3">Add Prospect</a>
    
    
    </div>

    <button class="collapsible"><h3>Actions</h3> </button>
    <div class="content">
      <a href="#" class="btn btn-primary mb-3">Add Action</a>
    
    
    </div>


    <button class="collapsible"><h3>Comments</h3></button>
    <div class="content">
      <a href="#" class="btn btn-primary mb-3">Add Comment</a> 
      {% if comments %}
        {% for doc in comments %}
        <p>{{ doc.comment }} - {{doc.user.username}}</a></p>
        {% endfor %}
      {% else %}
        <p>No comments found</p>
      {% endif %}
    </div>

</div>





<script>

var coll = document.getElementsByClassName("collapsible");
var i;

for (i = 0; i < coll.length; i++) {
  coll[i].addEventListener("click", function() {
    this.classList.toggle("active");
    var content = this.nextElementSibling;
    if (content.style.maxHeight){
      content.style.maxHeight = null;
    } else {
      content.style.maxHeight = content.scrollHeight + "px";
    } 
  });
}




  // Update the client address data in the server
  function updateClientAddressData(formData, token) {
    var url = "{% url 'crm:client_address_update_json_view' %}";

    return new Promise((resolve, reject) => {
      $.post(url, formData, function (data) {
        if (data.error) {
          reject(data.error);
        } else {
          console.log(data.success);
          resolve(data);
        }
      }).fail(function (jqXHR, textStatus, errorThrown) {
        var responseBody = JSON.parse(jqXHR.responseText);
        reject(responseBody.error);
      });
    });
  }





  // Request to the server to retrieve the address by postal code
  function retrieveAddressByPostalCode(form, formData) {
    return new Promise((resolve, reject) => {
      $.post("{% url 'address:postal_code_json' %}", formData, function (data) {
        if (data.error) {
          reject(data.error);
        }
        else {
          var streets = data.ART_TIPO_ART_DESIG;
          var newOptions = {
            ...form.options,
            formData: {
              ...form.options.formData,
              postal_code: data.CP4 + "-" + data.CP3,
              cp4: data.CP4,
              cp3: data.CP3,
              district: data.DD__DESIG,
              county: data.CC__DESIG,
              locality: data.LOCALIDADE,
              street: "",
              number: "",
              more_info: ""
            }
          };
          var streetField = findField(newOptions.items, 'street');
          if (streetField && streetField.editorOptions) {
            streetField.editorOptions.dataSource = streets;
          }
          form.setOptions(newOptions);
          resolve(data.success);
        }
      }).fail(function (jqXHR, textStatus, errorThrown) {
        var responseBody = JSON.parse(jqXHR.responseText);
        console.log("Error: ", responseBody.error);
        reject(responseBody.error);
      });
    });
  }






  // Inject the address data into the form
  function injectAddressData(form, data) {
    console.log("injectAddressData", form.options.formData);
    console.log("injectAddressData", data);
    var newOptions = {
      ...form.options,
      formData: {
        ...form.options.formData,
        id: data["address"][0]["id"],
        token: data["address"][0]["token"],
        cp3: data["address"][0]["cp3"],
        cp4: data["address"][0]["cp4"],
        postal_code: data["address"][0]["postal_code"],
        district: data["address"][0]["district"],
        county: data["address"][0]["county"],
        locality: data["address"][0]["locality"],
        street: data["address"][0]["street"],
        number: data["address"][0]["number"],
        more_info: data["address"][0]["more_info"],
      }
    };
    form.setOptions(newOptions);
  }





 

</script>

{% endblock %}